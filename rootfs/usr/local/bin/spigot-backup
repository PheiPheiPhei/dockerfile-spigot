#!/bin/bash

set -euo pipefail

source /usr/local/etc/spigot.conf

function exit_with_result() {
    case "${RESULT:-}" in
        completed)
            echo-pass "Backup completed"
            ;;
        *)
            echo-fail "Failed to backup"
            ;;
    esac
}

echo-info "Starting backup..."
trap exit_with_result EXIT

BACKUP_FILE="${BACKUP_DIR}/$(date "+${BACKUP_FILE_FORMAT}")"

if [ -e "${RESTORE_STATUS_FILE}" ]
then
    DIRECTORY="${RESTORE_DIR}"
else
    DIRECTORY="${SERVER_DIR}"
fi

tar \
-cz \
-f "${BACKUP_FILE}" \
-C "${DIRECTORY}" \
"${BACKUP_FILES[@]}"

echo-pass "${BACKUP_FILE}: Created"

# TODO rotate backup

RESULT=completed
